# 1Password CLI integration for Fish shell
{{- if .onepassword.enabled }}

# Load environment variables from bash-style .env file (if it exists)
if test -f {{ .chezmoi.homeDir }}/.env
    # Parse bash-style exports and convert to Fish syntax
    for line in (cat {{ .chezmoi.homeDir }}/.env | grep '^export ' | sed 's/^export //')
        set -l var_and_val (string split '=' -- $line)
        if test (count $var_and_val) -eq 2
            set -gx $var_and_val[1] (string replace -a '"' '' -- $var_and_val[2])
        end
    end
end

# 1Password SSH Agent is automatically configured via SSH config Include
# No additional SSH agent setup needed here

# Helper function to check 1Password CLI status
function op_status --description "Check 1Password CLI signin status"
    if op account list >/dev/null 2>&1
        echo "‚úÖ 1Password CLI: Signed in"
        op account list
        
        # Check SSH agent status
        if test -S ~/Library/Group\ Containers/2BUA8C4S2C.com.1password/t/agent.sock
            echo "‚úÖ 1Password SSH Agent: Running"
        else
            echo "‚ùå 1Password SSH Agent: Not running"
        end
    else
        echo "‚ùå 1Password CLI: Not signed in"
        echo "Sign in with: op signin"
    end
end

# Quick 1Password item retrieval
function op_get --description "Get item from 1Password"
    if test (count $argv) -lt 1
        echo "Usage: op_get <item_name> [field_name]"
        return 1
    end
    
    set item $argv[1]
    set field password
    if test (count $argv) -gt 1
        set field $argv[2]
    end
    
    op item get "$item" --field "$field" 2>/dev/null
end

# Load secrets into environment (secure)
function op_load_env --description "Load environment variables from 1Password"
    echo "üí° Load secrets into your Fish session:"
    echo "   set -gx GITHUB_TOKEN (op_get 'GitHub Personal Access Token')"
    echo "   set -gx OPENAI_API_KEY (op_get 'OpenAI API Key')" 
    echo ""
    echo "üîç Search your items: op item list | grep -i <search_term>"
end

{{- else }}

# 1Password CLI not available
function op_status --description "1Password CLI status (not available)"
    echo "‚ùå 1Password CLI not installed"
    echo "Install with: brew install 1password-cli"
end

function op_get --description "1Password CLI not available"
    echo "‚ùå 1Password CLI not installed"
    return 1
end

{{- end }}